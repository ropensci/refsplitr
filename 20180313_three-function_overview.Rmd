---
title: "20180313_three_function_overview"
output:
  pdf_document: default
  html_document: default
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(stringr)
library(stringi)
# devtools::install_github("embruna/refnet2", subdir = "refnet")  
library(refnet)
```


references<-read_references()

authors<-read_authors(references, sim_score=0.9)

At this stage you go through and change any incorrectly grouped authors groupID to their authorID.

This function takes those changes and makes the names all the same, filters again, and makes some small changes and deletes some columns for input to your functions

refine_authors is doing what merge_records and remove_duplicates did before 

authors_final<-refine_authors(authors, sim_score=0.94)

```{r, message=FALSE, eval=FALSE}



################
# EB TEST
################

eb_references <- read_references("./data/EBpubs.txt", dir=FALSE, filename_root="./output/eb")

eb_authors <- read_authors(eb_references, filename_root="./output/eb")

eb_refined <- refine_authors(authors=eb_authors$authors, master=eb_authors$master)
# ERROR MESSAGE: "no non-missing arguments to min; returning Inf>"
# I think it is because the eb_authors csv file is empty (no authors needed to be 2x) 

save(eb_refined, file="./output/eb_refined.Rdata")

address_lat_long(eb_refined)


########
# LARR
########

LARR_references <- read_references("./data/LARR/", dir=TRUE, filename_root="./output/LARR")

LARR_authors <- read_authors(LARR_references, filename_root="./output/LARR")

LARR_refined <- refine_authors(authors=LARR_authors$authors, master=LARR_authors$master)

save(LARR_refined, file="./output/LARR_refined.Rdata")

address_lat_long(LARR_refined)
# ERROR MESSAGE: "Error in `[.data.frame`(data, , c("state", "university", "city", "country",  :undefined columns selected"


################
# WOS 2018 TEST
################

WOS18_references <- read_references("./data/WOS2018", dir=TRUE, filename_root="./output/WOS18")

WOS18_authors <- read_authors(WOS18_references, filename_root="./output/WOS18")

WOS18_refined <- refine_authors(authors=WOS18_authors$authors, master=WOS18_authors$master)

save(WOS18_refined, file="./output/WOS18_refined.Rdata")

address_lat_long(WOS18_refined)
# ERROR MESSAGE: "Error in `[.data.frame`(data, , c("state", "university", "city", "country",  :undefined columns selected"


################
# WOS 2011 TEST
################

WOS11_references <- read_references("./data/WOS2011", dir=TRUE, 
                                    filename_root="./output/WOS11")

WOS11_authors <- read_authors(WOS11_references, filename_root="./output/WOS11")

WOS11_refined <- refine_authors(authors=WOS11_authors$authors, master=WOS11_authors$master)

save(WOS11_refined, file="./output/WOS11_refined.Rdata")

address_lat_long(WOS11_refined)
# ERROR MESSAGE: "Error in `[.data.frame`(data, , c("state", "university", "city", "country",  :undefined columns selected"


################
# ECOLOGY TEST
################

Ecology_references <- read_references("./data/Ecology.txt", dir=FALSE, filename_root="./output/Ecology")

Ecology_authors <- read_authors(Ecology_references, filename_root="./output/Ecology")

Ecology_refined <- refine_authors(authors=Ecology_authors$authors, master=Ecology_authors$master)

save(Ecology_refined, file="./output/Ecology_refined.Rdata")

address_lat_long(Ecology_refined)
# ERROR MESSAGE: "Error in `[.data.frame`(data, , c("state", "university", "city", "country",  :undefined columns selected"


################
# BITR TEST
################


BITR_references <- read_references("./data/BITR", dir=TRUE, filename_root="./output/BITR")

BITR_authors <- read_authors(BITR_references, filename_root="./output/BITR")
# ERROR MESSAGE: "Error in data.frame(names = unique(unlist(strsplit(C1_names, "; "))),  : row names contain missing values"

BITR_refined <- refine_authors(authors=BITR_authors$authors, master=BITR_authors$master)

save(BITR_refined, file="./output/BITR_refined.Rdata")

address_lat_long(BITR_refined)

```

```{r}
load("./output/eb_refined.Rdata")



dat <- separate(data=eb_refined, col = address, 
         into=c("university","department","short_address"),
         sep=",",extra = "merge", remove=FALSE) %>%
       mutate(country=stri_extract_last_words(short_address),
        zip = str_extract(string=short_address, 
          pattern="[:digit:][:digit:][:digit:][:digit:][:digit:]"),
        city_state = str_extract(string=short_address,
                pattern="[:alnum:]{1,20}[,][ ][A-Z][A-Z]") ) %>%
      select(address, short_address, city_state, zip, country, university, department)

#write.csv(dat, file = "dat_parsed_addresses.csv")

```

\newpage

```{r}
head(dat[,c("address")])
head(dat[,c("university","department")])
head(dat[,c("short_address","city_state","zip","country")])
```